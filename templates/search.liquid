{% assign chat_messages = site.chat_messages | order_by: '-created_at' | limit: 10 %}
{% assign avatar = site.default.avatar_url %}
{% unless avatar %}
  {% assign avatar = 'images/img-min/avatar.png' | asset_url %}
{% endunless %}

<main id="content" class="">
  <!-- =========={ HERO }==========  -->
  <div id="hero" class="relative py-12 jarallax">
    <!-- background parallax -->
    <img class="jarallax-img" src="{{ 'images/img-min/bg-planet.jpg' | asset_url }}" alt="{{ site.name }}">
    <!-- background overlay -->
    <div class="absolute top-0 start-0 w-full h-full opacity-90 bg-primary-700" style="z-index:-1;"></div>

    <div class="container xl:max-w-6xl mx-auto px-4">
      <div class="flex flex-wrap flex-row -mx-4 items-center justify-center">
        <!-- content -->
        <div class="max-w-full w-full lg:w-10/12 px-4">
          <div class="mt-0 py-6 text-center">
            <div class="mt-0 pt-8 text-center">
              <h1 class="text-3xl md:text-4xl leading-normal mb-0 font-bold text-white">AI 智能搜索</h1>           
            </div>
          </div>
        </div><!-- end content -->
      </div>
    </div>
  </div><!-- End hero -->
  
  <!-- =========={ POST }==========  -->
  <div class="sm:flex container mx-auto max-w-6xl my-12">
      <!-- start chat-leftsidebar -->
      <div class="min-w-[380px] max-w-[400px] px-8 py-8 h-screen overflow-y-auto hidden sm:block">
          <div class="">
            <h2 class="mb-4 text-xl font-bold">AI 智能搜索</h2>
          </div>

          <turbo-frame id="frame--search-results" class="overflow-hidden flex-1">
              {% assign extends_size = search.extends | size %}
              {% assign items_size = search.pages | size %}
              {% assign total_size = extends_size | plus: items_size %}
              <!-- 搜索框 -->
              
              {% if total_size > 0 %}
              {% paginate_tag search.pages, as: 'items', per: 10 %}
              <!-- 搜索结果 -->
              <div>
                  <h3 class="mb-4 text-base-content/50">搜索结果</h3>

                  <!-- 单条搜索结果 -->
                  <div class="space-y-5">

                      {% if search.page_number == 1 and extends_size > 0 %}
                        {% for link in search.extends %}
                          <div class="flex gap-3 items-start hover:bg-white">
                              <div class="flex-none text-lg font-semibold text-primary">{{ forloop.index }}</div>
                              <div class="flex-grow">
                                  <a class="text-base font-medium search-highlight-block" href="{{ page.url }}"
                                      data-turbo-frame="_top">
                                      {{ link.link_text }}
                                  </a>

                                  <a class="text-sm leading-6 break-all text-base-content/50 line-clamp-2" href="{{ page.url }}"
                                      data-turbo-frame="_top" x-cloak>{{ {{ link.url
                                      }}
                                  </a>
                              </div>
                          </div>
                        {% endfor %}
                      {% endif %}

                      {% for page in items %}
                        <div class="flex gap-3 items-start group group-hover:bg-white border-b">
                            <div class="flex-none text-lg font-semibold text-primary">{{ forloop.index }}</div>
                            <a class="flex-grow hover:text-secondary" href="{{ page.url }}" data-turbo-frame="_top" x-cloak>
                                <h3 class="text-lg font-semibold">{{ page.highlighted_search_title }}</h3>
                                {% unless page.highlighted_search_content == empty %}
                                <p class="text-sm leading-6 break-all text-base-content/50 line-clamp-2 search-highlight-block">
                                    {{ page.highlighted_search_content}}
                                </p>
                                {% endunless %}
                            </a>
                        </div>
                      {% endfor %}
                  </div>

                  <div class="flex relative justify-center px-3 my-8">
                      {% render 'paginate', paginate: paginate %}
                  </div>
              </div>
              {% endpaginate_tag %}
              {% endif %}
          </turbo-frame>
      </div>
      <!-- end chat-leftsidebar -->
      {% assign ai_search_thinking_text = 'ai.thinking' | t: 'AI 正在思考...' %}
      {% assign ai_search_canceled_text = 'ai.canceled' | t: "已取消回答" %}
      <!-- Start User chat -->
      <div class="overflow-hidden w-full" id="js--ai-search-completion-container"  x-data="{ tab: 'chat' }" >
          <div class="sm:flex" :class="{'hidden': tab !== 'chat'}" id="js--ai-search-completion" data-controller="ai-search-completion"
              data-ai-search-completion-hidden-class="hidden opacity-0"
              data-ai-search-completion-messages-value='{"thinking":"{{ ai_search_thinking_text }}","completed":"{{ site.settings.ai_search_completed_text | escape_once }}","canceled":"{{ ai_search_canceled_text }}"}'
              data-ai-search-completion-url-value="/-/ai-search-completion"
              data-ai-search-completion-auto-submit-value="true">
              <div class="flex flex-col flex-1 min-h-screen">
                  <!-- 欢迎语 -->
                  <div class="flex justify-between items-center px-8 h-16 border-b border-base-content/15">
                      <!-- 左侧绿色小圆点 -->
                      <span class="relative size-3 hidden sm:block">
                          <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-primary opacity-75"></span>
                          <span class="relative inline-flex size-3 rounded-full bg-primary-500"> </span>
                      </span>
                      <button class="pb-2 ml-2 w-1/2 text-sm border-b-2 sm:hidden" :class="{'border-primary text-primary': tab === 'chat'}" @click="tab = 'chat'">AI 对话</button>
                      <div class="flex w-full sm:hidden">
                      <button class="pb-2 w-1/2 text-sm border-b-2 sm:hidden" :class="{'border-primary text-primary': tab === 'search'}" @click="tab = 'search'">搜索结果</button>
                      </div>
                      <!-- 右侧更多操作 -->
                  </div>

                  <div class="h-[calc(100vh-184px)] overflow-y-auto p-4 relative bg-white">
                      {% comment %} AI 搜索结果区域 {% endcomment %}
                      <div class="flex-grow-0 order-1 w-full md:order-2 md:w-full">
                          <div class="p-4 space-y-2 rounded bg-primary-50 chat-container">
                              <div
                                  class="overflow-y-auto gap-2 ai-response prose scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                                  {% for message in chat_messages reversed %}
                                  {% if message.role == 'user' %}
                                  <div class="flex gap-3 justify-end items-start">
                                      <div class="text-right">
                                          <div
                                              class="inline-block p-3 max-w-xs break-words rounded-xl rounded-br-none bg-info text-info-content ai-user-message">
                                              {{ message.content }}
                                          </div>
                                          <div class="mt-2 text-sm font-medium text-base-content/80"> {{ current_user.name }} </div>
                                      </div>
                                      <img src="{{ current_user.image |  default: avatar }}" class="w-10 h-10 rounded-full" />
                                  </div>
                                  {% else %}
                                  <div class="flex gap-3 items-start">
                                      <div class="avatar avatar-online avatar-placeholder">
                                          <div class="">
                                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 w-8 h-8 text-primary">
                                                  <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm0 18a8 8 0 1 1 8-8a8.009 8.009 0 0 1-8 8z" />
                                                  <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" />
                                              </svg>
                                          </div>
                                      </div>
                                      <div class="flex-1 min-w-0" data-controller="markdown-renderer">
                                          <div class="p-3 break-words rounded-xl rounded-bl-none text-info-content w-fit max-w-3/4 ai-assistant-message chat-bubble prose ProseMirror"
                                              data-markdown-renderer-target="content">{{ message.content }}
                                          </div>

                                          <div class="mt-1 text-sm font-medium text-base-content/80">
                                              {{ site.settings.robot_name }}
                                          </div>
                                      </div>
                                  </div>
                                  {% endif %}
                                  {% endfor %}
                              </div>

                              <div data-ai-search-completion-target="messages"
                                  class="overflow-y-auto gap-2 ai-response prose scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
                                  <!-- 多轮消息将在这里显示 -->
                              </div>
                              <template data-ai-search-completion-target="userMessageTemplate">
                                  <div class="flex gap-3 justify-end items-start">
                                      <div class="text-right">
                                          <div
                                              class="inline-block p-3 max-w-xs break-words rounded-xl rounded-br-none bg-info text-info-content ai-user-message">
                                          </div>
                                          <div class="mt-2 text-sm font-medium text-base-content/80"> {{ current_user.name }} </div>
                                      </div>
                                      <img src="{{ current_user.image | default: avatar }}" class="w-10 h-10 rounded-full" />
                                  </div>
                              </template>
                              <template data-ai-search-completion-target="assistantMessageTemplate">
                                  <div class="flex gap-3 items-start">
                                      <div class="avatar avatar-online avatar-placeholder">
                                          <span class="p-2 flex rounded-full border border-primary bg-radial from-pink-400 from-40% to-fuchsia-700">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-6 !text-primary">
                                              <path d="M15.98 1.804a1 1 0 0 0-1.96 0l-.24 1.192a1 1 0 0 1-.784.785l-1.192.238a1 1 0 0 0 0 1.962l1.192.238a1 1 0 0 1 .785.785l.238 1.192a1 1 0 0 0 1.962 0l.238-1.192a1 1 0 0 1 .785-.785l1.192-.238a1 1 0 0 0 0-1.962l-1.192-.238a1 1 0 0 1-.785-.785l-.238-1.192ZM6.949 5.684a1 1 0 0 0-1.898 0l-.683 2.051a1 1 0 0 1-.633.633l-2.051.683a1 1 0 0 0 0 1.898l2.051.684a1 1 0 0 1 .633.632l.683 2.051a1 1 0 0 0 1.898 0l.683-2.051a1 1 0 0 1 .633-.633l2.051-.683a1 1 0 0 0 0-1.898l-2.051-.683a1 1 0 0 1-.633-.633L6.95 5.684ZM13.949 13.684a1 1 0 0 0-1.898 0l-.184.551a1 1 0 0 1-.632.633l-.551.183a1 1 0 0 0 0 1.898l.551.183a1 1 0 0 1 .633.633l.183.551a1 1 0 0 0 1.898 0l.184-.551a1 1 0 0 1 .632-.633l.551-.183a1 1 0 0 0 0-1.898l-.551-.184a1 1 0 0 1-.633-.632l-.183-.551Z" />
                                            </svg>
                                          </span>
                                      </div>
                                      <div class="flex-1 min-w-0">
                                          <div
                                              class="p-3 break-words rounded-xl rounded-bl-none text-info-content bg-gray-100 dark:text-white w-fit max-w-3/4 ai-assistant-message chat-bubble prose ProseMirror">
                                          </div>
                                          <div class="mt-1 text-sm font-medium text-base-content/80">
                                              {{ site.settings.robot_name }}
                                          </div>
                                      </div>
                                  </div>
                              </template>
                              <div data-ai-search-completion-target="error"
                                  class="hidden text-red-500 opacity-100 transition-opacity duration-300"></div>
                          </div>
                          <script>
                              (function () {
                                  setTimeout(function () {
                                      const aiSearchCompletionContainer = document.getElementById('js--ai-search-completion-container');
                                      const aiSearchCompletion = document.getElementById('js--ai-search-completion');
                                      aiSearchCompletion.dataset.aiSearchCompletionMessageValue = "{{ search.keywords | escape_once }}";
                                      setTimeout(function () {
                                          scrollToMessages();
                                      }, 1000);
                                  }, 1000);
                              })()
                          </script>
                          <script>
                              var searchInput = null;
                              var chatInput = null;
                              var sendBtn = null;

                              function updateSearchInput() {
                                  var frame = document.getElementById('frame--search-results');
                                  searchInput = frame ? frame.querySelector('#js--search-input') : null;
                              }

                              function initializeChat() {
                                  chatInput = document.getElementById('js--ai-chat-input');
                                  sendBtn = document.getElementById('js--ai-chat-send');
                                  updateSearchInput();

                                  // 输入时同步
                                  function syncToSearchInput() {
                                      if (searchInput && chatInput && searchInput.value !== chatInput.value) {
                                          searchInput.value = chatInput.value;
                                      }
                                  }

                                  if (chatInput) {
                                      chatInput.addEventListener('input', syncToSearchInput);

                                      // 回车时直接提交
                                      chatInput.addEventListener('keydown', function (e) {
                                          if (e.key === 'Enter') {
                                              scrollToMessages()
                                              if (searchInput) {
                                                  var form = searchInput.form;
                                                  if (form) form.requestSubmit();
                                              }
                                              e.preventDefault();
                                          }
                                      });
                                  }

                                  // 点击按钮时直接提交
                                  if (sendBtn) {
                                      sendBtn.addEventListener('click', function () {
                                          scrollToMessages()
                                          if (searchInput) {
                                              var form = searchInput.form;
                                              if (form) form.requestSubmit();
                                          }
                                      });
                                  }
                              };

                              // Turbo 导航完成后重新初始化
                              document.addEventListener('turbo:load', initializeChat);
                              document.addEventListener('turbo:frame-load', function (event) {
                                  if (event.target.id === 'frame--search-results') {
                                      updateSearchInput(); // 仅当搜索结果 Frame 刷新时，更新 input
                                  }
                              });

                              function scrollToMessages() {
                              const messagesElement = document.querySelector('[data-ai-search-completion-target="messages"]');
                              if (messagesElement) {
                                  messagesElement.scrollIntoView({
                                  block: 'end',
                                  behavior: 'auto'
                                  });
                              }
                              }
                          </script>
                      </div>
                  </div>

                  <div class="chat-mobile bg-white">
                      <div class="flex items-center rounded-xl p-4 bg-gradient-to-b from-primary/15 to-secondary/15 border border-base-content/15">
                          <!-- 输入框 -->
                          <textarea id="js--ai-chat-input"
                          data-ai-search-completion-target="input" autocomplete="off"
                          class="flex-1 p-2 mr-4 rounded-lg border-1 bg-white sm:min-h-20 text-base-content input input-bordered focus:outline-none focus:ring-0 placeholder:text-base-content/60" placeholder="请输入你的问题…"></textarea>

                          <button id="js--ai-chat-send" data-ai-search-completion-target="send" type="button" class="bg-primary text-white rounded-md p-2 px-4 md:py-4 hover:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-primary/50">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6 w-6 h-6 md:w-12 md:h-12">
                                  <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd" />
                              </svg>
                          </button>
                      </div>
                  </div>
              </div>
          </div>

          <div class="px-8 sm:hidden" :class="{'hidden': tab !== 'search'}">
              <div class="flex justify-between items-center px-8 h-16 border-b border-base-content/15 bg-gray-100">
                  <!-- 左侧绿色小圆点 -->
                  <span class="hidden sm:block">会话中 <i class="ri-record-circle-fill font-size-10 text-secondary d-inline-block ms-1"></i>
                  </span>
                  <button class="pb-2 ml-2 w-1/2 text-sm border-b-2" :class="{'border-primary text-primary': tab === 'chat'}" @click="tab = 'chat'">AI 对话</button>
                  <div class="flex w-full sm:hidden">
                  <button class="pb-2 w-1/2 text-sm border-b-2" :class="{'border-primary text-primary': tab === 'search'}" @click="tab = 'search'">搜索结果</button>
                  </div>
                  <!-- 右侧更多操作 -->
              </div>
              <turbo-frame id="frame--search-results-mobile" class="overflow-hidden flex-1">
                  <!-- 搜索框 -->
                  <label class="flex gap-2 items-center mb-4 w-full input input-bordered">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 opacity-70" fill="none" viewBox="0 0 24 24"
                          stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 21l-6-6m2-5a7 7 0 10-14 0 7 7 0 0014 0z" />
                      </svg>

                      {% form_tag 'search', class: 'w-full' %}
                      <input type="text" class="grow"  placeholder="输入关键词过滤"
                          name="{{form.keywords_field_name}}" value="{{ search.keywords | escape_once }}" placeholder="{{ "
                          layout.theme.search_input_placeholder" | t }}" autocomplete="off" />
                      <button type="submit" class="hidden"></button>
                      {% endform_tag %}
                  </label>
                  {% if total_size > 0 %}
                  {% paginate_tag search.pages, as: 'items', per: 10 %}
                  <!-- 搜索结果 -->
                  <div>
                      <h3 class="mb-4 text-sm text-base-content/50">搜索结果</h3>

                      <!-- 单条搜索结果 -->
                      <div class="space-y-5">
                          {% if search.page_number == 1 and extends_size > 0 %}
                          {% for link in search.extends %}
                          <div class="flex gap-3 items-start">
                              <div class="flex-none text-lg font-semibold text-primary">{{ forloop.index }}</div>
                              <div class="flex-grow">
                                  <a class="text-base font-medium search-highlight-block" href="{{ page.url }}"
                                      data-turbo-frame="_top">
                                      {{ link.link_text }}
                                  </a>

                                  <a class="text-sm leading-6 break-all text-base-content/50 line-clamp-2" href="{{ page.url }}"
                                      data-turbo-frame="_top" x-cloak>{{ {{ link.url
                                      }}
                                  </a>
                              </div>
                          </div>
                          {% endfor %}
                          {% endif %}

                          {% for page in items %}
                          <div class="flex gap-3 items-start">
                              <div class="flex-none text-lg font-semibold text-primary">{{ forloop.index }}</div>
                              <div class="flex-grow">
                                  <a class="text-base font-medium search-highlight-block" href="{{ page.url }}"
                                      data-turbo-frame="_top">
                                      {{ page.highlighted_search_title }}
                                  </a>
                                  {% unless page.highlighted_search_content == empty %}
                                  <a class="text-sm leading-6 break-all text-base-content/50 line-clamp-2 search-highlight-block"
                                      href="{{ page.url }}" data-turbo-frame="_top" x-cloak>{{ page.highlighted_search_content
                                      }}
                                  </a>
                                  {% endunless %}
                              </div>
                          </div>
                          {% endfor %}
                      </div>

                      <div class="flex relative justify-center px-3 my-8">
                          {% render 'paginate', paginate: paginate %}
                      </div>
                  </div>
                  {% endpaginate_tag %}
                  {% endif %}
              </turbo-frame>
          </div>
          <!-- End User chat -->
      </div>
      <!-- end  layout wrapper -->
  </div>
</main>
